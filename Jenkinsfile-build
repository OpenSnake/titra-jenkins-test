pipeline {
  agent any 

  environment {
    ARTIFACT_DIR = 'build'
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/OpenSnake/titra-test.git'
      }
    }

    stage('Install Meteor & Dependencies') {
      steps {
        sh '''
          curl https://install.meteor.com/ | sh
          export PATH="$HOME/.meteor:$PATH"
          meteor npm install
          meteor npm install --no-save eslint mocha
        '''
      }
    }

    stage('Lint') {
      steps {
        sh '''
          export PATH="$HOME/.meteor:$PATH"
          npx eslint . --ext .js || true
        '''
      }
    }

    stage('Test') {
      steps {
        sh '''
          export PATH="$HOME/.meteor:$PATH"
          npx mocha tests/**/*.js --exit
        '''
      }
    }

    stage('Build') {
      steps {
        sh '''
          export PATH="$HOME/.meteor:$PATH"
          mkdir -p ${ARTIFACT_DIR}
          meteor build ${ARTIFACT_DIR} --architecture os.linux.x86_64
        '''
      }
    }

    stage('Archive Artifact') {
      steps {
        archiveArtifacts artifacts: "${ARTIFACT_DIR}/*.tar.gz", fingerprint: true
        echo "Artifact saved in ${ARTIFACT_DIR}"
      }
    }
  }

  post {
    success {
      echo '✅ Build successful'
    }
    failure {
      echo '❌ Build unsuccessful'
    }
  }
}
